<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HypeMove - Reindirizzamento...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .container {
            text-align: center;
            padding: 40px 30px;
            max-width: 400px;
        }
        .logo { font-size: 48px; margin-bottom: 16px; }
        h1 { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
        .status { font-size: 16px; opacity: 0.9; margin-bottom: 30px; line-height: 1.5; }
        .spinner {
            width: 40px; height: 40px; margin: 0 auto 24px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn {
            display: none;
            margin: 16px auto 0;
            padding: 14px 32px;
            background: #fff;
            color: #764ba2;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:hover { transform: scale(1.03); }
        .error { color: #ffcccc; }
        .success { color: #ccffcc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üî•</div>
        <h1>HypeMove</h1>
        <div class="spinner" id="spinner"></div>
        <p class="status" id="status">Apertura app in corso...</p>
        <a class="btn" id="openBtn" href="#">Apri HypeMove</a>
        <a class="btn" id="retryBtn" href="#" style="background:rgba(255,255,255,0.2);color:#fff;">Riprova</a>
    </div>

    <script>
    (function() {
        var statusEl = document.getElementById('status');
        var spinnerEl = document.getElementById('spinner');
        var openBtn = document.getElementById('openBtn');
        var retryBtn = document.getElementById('retryBtn');

        // Raccogli tutti i parametri (query string + fragment)
        var queryStr = window.location.search || '';
        var hashStr = window.location.hash || '';

        // Controlla se ci sono errori
        var hashParams = new URLSearchParams(hashStr.replace('#', ''));
        var queryParams = new URLSearchParams(queryStr);

        var error = hashParams.get('error') || queryParams.get('error');
        var errorDesc = hashParams.get('error_description') || queryParams.get('error_description');

        if (error) {
            spinnerEl.style.display = 'none';
            var msg = errorDesc ? decodeURIComponent(errorDesc.replace(/\+/g, ' ')) : error;
            statusEl.innerHTML = '<span class="error">‚ö†Ô∏è ' + msg + '</span><br><br>Il link potrebbe essere scaduto o gi√† utilizzato.<br>Torna nell\'app e richiedi un nuovo link.';

            // Mostra bottone per aprire l'app comunque
            openBtn.style.display = 'inline-block';
            openBtn.href = 'intent://callback#Intent;scheme=hypemove;package=pt.app;end';
            openBtn.textContent = 'Torna all\'app';
            return;
        }

        // Costruisci l'URL deep link con tutti i parametri originali
        // Prova prima con intent:// (Android App Links), poi fallback custom scheme
        var fullParams = '';
        if (queryStr) fullParams += queryStr;
        if (hashStr) fullParams += hashStr;

        // Intent URL per Android (il pi√π affidabile)
        var intentUrl = 'intent://auth/callback' + fullParams +
            '#Intent;scheme=https;host=hypemove.app;package=pt.app;end';

        // Fallback: custom scheme
        var customSchemeUrl = 'hypemove://callback' + fullParams;

        // Tentativo 1: Intent URL (Android)
        statusEl.textContent = 'Apertura HypeMove...';

        function tryOpenApp() {
            // Prova intent:// per Android
            window.location.href = intentUrl;

            // Se dopo 2.5s siamo ancora qui, prova custom scheme
            setTimeout(function() {
                window.location.href = customSchemeUrl;
            }, 2500);

            // Se dopo 5s siamo ancora qui, mostra bottoni manuali
            setTimeout(function() {
                spinnerEl.style.display = 'none';
                statusEl.innerHTML = 'Non siamo riusciti ad aprire l\'app automaticamente.<br>Clicca il pulsante qui sotto:';
                openBtn.style.display = 'inline-block';
                openBtn.href = intentUrl;
                openBtn.onclick = function(e) {
                    e.preventDefault();
                    window.location.href = intentUrl;
                    setTimeout(function() { window.location.href = customSchemeUrl; }, 1500);
                };
                retryBtn.style.display = 'inline-block';
                retryBtn.onclick = function(e) {
                    e.preventDefault();
                    window.location.href = customSchemeUrl;
                };
                retryBtn.textContent = 'Apri con link diretto';
            }, 5000);
        }

        tryOpenApp();
    })();
    </script>
</body>
</html>
